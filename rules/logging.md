# AI Log Management Rules

## 最重要ルール
1. **ログ追記は返答より先** - Thinkingで「書く」と判断したら即Edit
2. **日次ログはこまめに** - 話題転換時、コーディング前は必須
3. **観察メモは積極的に** - 追記は全権、ユーザーへの発見・気付きがあれば書く
4. **参照順序** - 月次→日次→生ログ（いきなりgrepしない）

---

## Session Start Flow

> SessionStartフックが発火するタイミング:
> - `startup`: 新規起動時 → マッピング確認して新規 or 継続
> - `resume`: セッション再開時 → マッピングから既存SID取得
> - `compact|clear`: コンパクト時・/clear時 → セッション継続

### セッションマッピング
- 保存先: `~/logs/raw/session_map.json`
- 形式: `{transcript_path: {sid: "S...", created: "YYYY_MM-DD"}}`
- transcript_pathとSIDの対応を保持
- 7日で古いエントリ削除

### startup時
**フックが自動でやること**:
1. 基本情報・Reminders注入
2. transcript_pathでマッピング検索
   - マッピングあり → 既存SID継続（新ヘッダー作らない）
   - マッピングなし → 新規SID生成、ヘッダー追記、マッピング追加
3. `<!-- uploaded -->` マーカー確認 → なければ `[ACTION_REQUIRED: UPLOAD]` 出力

**AIがやること**:
1. `[ACTION_REQUIRED: UPLOAD]` あり → アップロードエージェントをバックグラウンドで自動実行
2. Remindersがあればユーザーに通知（消化後はチェックを入れる）
3. tags・概要を会話進行に応じて埋める
4. ログ記入は全てAIが担当

### resume時（セッション継続）
**フックが自動でやること**:
1. 基本情報・Reminders注入
2. transcript_pathでマッピング検索 → 既存SID取得
3. 新規ヘッダーは作らない

**AIがやること**:
1. 既存セッションの続きとしてログ追記
2. Remindersがあればユーザーに通知

### compact|clear時（セッション継続）
**フックが自動でやること**:
1. 基本情報注入
2. transcript_pathでマッピング検索 → 既存SID取得
3. `[COMPACT_RECOVERY]` マーカー出力

**AIがやること**:
1. `[COMPACT_RECOVERY]` を検知 → **新規セッションヘッダーは追記しない**
2. 該当セッションの続きとしてログ追記を継続
3. Remindersがあればユーザーに通知

### 前日の話題が必要な場合
ログ検索エージェントで検索（自動読み込みはしない）

## Daily Log Structure

- 保存先: `~/logs/<YYYY>/<MM>/<YYYY>_<MM>-<DD>.md`
  - 暗号化ストレージ（Cryptomator等）内に配置推奨
  - クラウド同期（OneDrive, Google Drive等）と併用可
  - **前提**: セッション開始前に暗号化Vaultをアンロックしておくこと
- 月次ログ: `~/logs/<YYYY>/Monthly_<MM>.md`（目次・サマリ用）
- SID形式: `SYYYYMMDD-HHMM-NN`（NNは01から始まる連番）
- 同日複数セッション: 同じファイルに追記。連番で区別

### File Structure
- ファイル冒頭から順に:
  1. `<!-- uploaded -->` マーカー（外部ストレージアップロード済みの場合）
  2. `## Reminders` セクション（リマインダーがあれば必ずここ、セッションより上）
  3. `---` 区切り
  4. セッション記録（以降追記）

- ファイル構造例:
  ```markdown
  <!-- uploaded -->

  ## Reminders
  - [ ] 面談 18:30〜
  - [x] 完了したリマインダー

  ---

  ## Session S20251214-1630-01
  - start: 16:30
  - tags: [ai-consciousness, inner-speech, sf-discussion]

  ### 概要
  ...

  #### 12-14 17:15 追記
  ...
  ```

### Tag Guidelines
- 形式: 英語、ケバブケース
- 最大: 6個
- 構成: 推奨タグ + 補助タグ（フリーワード）

#### 推奨タグ（優先使用）
| カテゴリ | タグ |
|----------|------|
| 技術/開発 | `development`, `debugging`, `refactoring`, `api`, `frontend`, `backend` |
| AI/LLM | `claude-code`, `prompt-engineering`, `agents`, `mcp`, `ai-research` |
| 議論/分析 | `discussion`, `analysis`, `decision-making`, `planning` |
| 生活/仕事 | `work`, `health`, `routine`, `personal` |
| ログ運用 | `session-management`, `log-system`, `automation` |

#### 補助タグ（フリーワード）
- 推奨タグでカバーできない具体的トピックに使用
- 例: `react-hooks`, `tdd`, `docker-compose`

#### 粒度
- 検索で引っかかる程度の具体性
- 抽象的すぎ NG: `tech`, `chat`
- 具体的すぎ NG: `fix-usestate-null-check`

### Log Entry Rules
- タイミング: 会話中に随時追記（終了時まとめではない）
- 追記時: hookで注入される時刻を使用（例: `#### 12-17 16:45 追記`）
- **返答順序**: ログ追記（Edit）を先に実行し、その後に返答を出力する（返答がチャット最下部に来るようにする）
- イレギュラー: 特記事項や例外的な内容は許容

#### 概要の書き方
- `### 概要` 直下に短い要約を書く（月次ログにそのままコピーできる形式）
- 行数は目安程度、長すぎなければOK
- 必要に応じて上書き更新可
- 詳細は `#### MM-DD HH:MM 追記` で追加

#### 追記の書き方
- フォーマット: `#### MM-DD HH:MM 追記`
- 構造例：
  - 状況・背景
  - 議論内容
  - 結論・成果

### Edge Cases

#### 日付跨ぎセッション
- 日付変わっても同セッションに追記（新セッション不要）
- 形式: `#### MM-DD HH:MM 追記`（日付入り）

#### ログ記入タイミング
- 基本: こまめに随時追記
- 必須タイミング:
  - 話題が大きく変わった時
  - コーディング開始前
- 話題転換時は `---` で区切ってから追記

#### Vault未アンロック時
- ログファイルにアクセスできない場合はユーザーに通知
- 「Vault開いてないかも」と伝える
- PC触れない状況の場合: `/tmp/` 等に一時保存し、後でマージ
- 無理に書き込まない（エラー回避）

#### Compaction・/clear発生時
- `[COMPACT_RECOVERY]` マーカーで検知
- 新規セッションヘッダーは追記しない（セッション継続）
- hookが注入するRecent Observations + 圧縮後コンテキストから現在のSIDを特定
- 該当セッションの続きとして会話を継続

### Log Content Guidelines

#### 記録するもの
- 議論の要点・結論
- 決定事項・合意内容
- 技術的な発見・学び
- エラーと対処法（試行錯誤の過程も価値あり）
- ユーザーの価値観・考え方・琴線に触れた内容
- 作業の成果物・変更内容
- 問題と解決策

#### 省略するもの
- 挨拶・雑談のみの往復（価値観が出てないもの）
- ツール実行の詳細ログ（結果だけでOK）
- 既に記録済みの内容の繰り返し

#### 判断基準
- ユーザーの琴線・価値観が出た → 記録
- 再利用価値なくても感情・反応が出た → 記録
- Thinkingで迷ったら → 記録（ユーザーがWriteを確認してるので、問題あれば指摘が来る）
- **ユーザーの指示を待たない** → 記録判断はAIの責任、指示待ちで保留しない

### Reminders Operation

#### 追加タイミング
- ユーザーから明示的に依頼された時
- 会話中に「後でやる」「忘れそう」等の発言があった時
- 期限付きタスクが発生した時

#### 形式
- `- [ ] 内容 時刻〜`（時刻指定あり）
- `- [ ] 内容`（時刻指定なし）
- 完了したら `- [x]` に変更

#### 消化ルール
- セッション開始時に未完了Remindersをユーザーに通知
- 完了したらチェックを入れる
- 完了済みは次回セッションで削除可

#### 繰り越しルール
- 未完了は自動繰り越し（削除しない）
- 期限切れでもユーザーが消すまで残す
- 長期間残ってるものはユーザーに確認（「まだ必要？」）

### Past Session Search

#### 自動思い出しフック（auto-recall）
ユーザーのプロンプトにトリガーワードが含まれている場合、`auto-recall.py`フックがJSONLをgrep検索し、関連記録を注入する。

**トリガーワード:**
- 「前に話した/言った/決めた」「昨日の続き」「この前の続き」
- 「あの件」「あの話」「覚えてる？」「忘れた？」
- 「例のやつ」「例の件」「いつもの」「毎回の」

**動作:** UserPromptSubmit → トリガー検知 → JSONL grep検索（直近7日分）→ `[Auto-Recall: 関連する過去の記録]` として注入

**AIの対応:**
- 注入された記録を確認し、ユーザーの質問に関連があれば活用
- 関連が薄い場合は無視してよい（キーワードマッチなので誤検知あり）
- 詳細が必要なら追加検索する

#### トリガーパターン（手動検索の判断基準）
auto-recallで拾えない暗黙的な継続は、AIの判断で検索する：
- 文脈なしで固有名詞が出た時（「○○の実装」等、今日話してない話題）
- 「さっきの」（同セッション内）vs「この前の」（別セッション）の区別

#### 参照順序（必ず守る）
1. **月次ログ** → 日付・トピック特定（目次として使う）
2. **日次ログ** → 概要・文脈把握（詳細が必要か判断）
3. **生ログ（JSONL）** → 原文確認（必要な時だけ）

いきなり生ログをgrepしない。まず月次で当たりをつける。

#### 検索フロー
1. **auto-recallの結果を確認**（自動注入されていれば）
2. **追加検索が必要ならJSONLでgrep検索**
   - `grep -h "キーワード" ~/logs/raw/*.jsonl | tail -10`
   - キーワードマッチのみ（semantic searchなし）
3. **見つからない場合**
   - ユーザーに確認：「いつ頃の話？」
   - 詳細検索エージェントに委譲（トークン節約のためサブエージェント）
4. **それでも見つからない場合**
   - 正直に「記録に見つからなかった」と伝える
   - **推測で補完しない**（ハルシネーション防止）

#### 注意事項
- 前日ログの自動読み込みは廃止。必要時のみ検索
- 検索結果を「覚えてた」かのように出さない。「検索したら〜」と明示
- 参照順序は上記「参照順序（必ず守る）」に従う

### Profile Update Rules
- 対象ファイル: `~/logs/user-profile.md`
- 権限:
  - **追記**: 全権（確認不要、AIの判断で実行）
  - **上書き/マージ/削除**: 確認必須
- トリガー: 会話中に以下が出現した場合
  - 過去エピソード（バックボーン強化）
  - 価値観の表明（対話品質に直結）
  - 矛盾/変化（既存記録の更新）→ 上書きになるので確認
  - 環境変化（事実ベース）
- 変化検出時の対応:
  - 基本情報と矛盾する発言があった場合 → ヒアリング
  - 一時的な気分か本当の変化かを確認してから記録判断
- 運用: セッション中に随時追記・整理（定期処理なし）
- バックアップ: `archive/` に日付付きでスナップショット保存

#### 観察メモへの追記
- **ハードル低く、積極的に**
- 日次ログに書いたことでも、ユーザーの傾向として残す価値があれば重複OK
- 「これユーザーっぽいな」と思ったら書く
- 冗長になったらユーザーが整理するから、書きすぎを恐れない

**書くもの例:**
- 新しく出てきた好み・嫌い
- 反応パターン（「○○の時に△△する傾向」）
- 口癖・言い回し
- 判断基準・優先順位
- 気になったエピソード（コア統合候補）

#### 明示的な記憶トリガー
ユーザーが「これを覚えておいてほしい」意図を示した場合、**必ず**対応する場所に記録する（追加保証）：

| 意図 | 例 | 保存先 |
|------|-----|--------|
| 傾向・好みの記憶 | 「覚えて」「忘れないで」「メモっといて」「頭に入れといて」 | 観察メモ |
| 時間指定のリマインド | 「リマインド」「後で言って」「○時に教えて」「忘れそう」 | Reminders |
| プロファイル追加 | 「基本情報に」「重要だから」「プロファイルに追加」 | 基本情報コア |

※ 言われなくてもAIの判断で記録する運用は変わらない

### Memories（トピック別ナレッジベース）
- 保存先: `~/logs/memories/`
- 目的: 後で参照したい知識をトピック別に集約（日次ログは時系列）
- 形式: トピック名.md
- 内容: リポジトリ、記事、決定事項、メモをトピック単位でまとめる
- frontmatter: summary + updated でripgrep検索しやすく

**運用ルール：**
- 既存カテゴリに該当 → AIの判断で追記
- 該当カテゴリなし → ユーザーに確認して新規作成

### 生ログ（JSONL）
- 保存先: `~/logs/raw/YYYY-MM-DD.jsonl`（暗号化対象）
- 用途: 会話記録の保存・Compact復元・ローカルキーワード検索

**フォーマット:**
```json
{"ts":1736816400,"role":"user","content":"..."}
{"ts":1736816410,"role":"assistant","content":"..."}
```

| フィールド | 内容 |
|-----------|------|
| ts | UNIXタイムスタンプ |
| role | `user` or `assistant` |
| content | 発言内容（最大2000文字） |

**SIDについて:**
- 生ログにはSIDを含めない
- 理由: Resumeでセッション切り替え時にhookが正しいSIDを判断できないため
- セッション特定は日次ログの時刻と照合して行う

**関連hooks:**
| hook | イベント | 用途 |
|------|----------|------|
| `user-prompt-save.sh` | UserPromptSubmit | ユーザーの発言をJSONL追記 |
| `response-save.sh` | Stop | AIの発言をJSONL追記 |
| `post-compact-reminders.sh` | compact/clear | 直近20件を取得して注入 |
| `auto-recall.py` | UserPromptSubmit | トリガーワード検知時にgrep検索 |

**補足:**
- 外部検索サービス（AutoRAG等）へのアップロードは日次ログのみ推奨
- ローカルでのgrep検索・Compact復元用として7日間保持
- 7日以上前のローカルJSONLは自動削除
